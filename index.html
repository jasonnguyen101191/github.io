<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nail Salon – VND • Tip • Auto Assign</title>
  <style>
    :root{
      --bg:#f5f5f7; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 12px 30px rgba(0,0,0,.10); --radius:18px;
      --primary:#111827; --soft:#f3f4f6; --good:#047857; --bad:#b91c1c; --warn:#b45309;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .topbar{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.86);backdrop-filter:blur(12px);border-bottom:1px solid rgba(0,0,0,.08)}
    .topbar-inner{max-width:1220px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand .dot{width:12px;height:12px;border-radius:999px;background:var(--primary)}
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .nav a{text-decoration:none;color:var(--text);font-size:14px;opacity:.75;padding:8px 12px;border-radius:999px}
    .nav a.active{opacity:1;background:var(--primary);color:#fff}
    .btn{border:0;border-radius:14px;padding:10px 12px;cursor:pointer;background:var(--primary);color:#fff;font-weight:800}
    .btn.ghost{background:var(--soft);color:var(--text)}
    .btn.danger{background:#ef4444}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns: 1.05fr .95fr}
    .grid-3{grid-template-columns: repeat(3, minmax(0,1fr))}
    @media (max-width: 950px){ .grid-2,.grid-3{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .title{font-size:16px;font-weight:900;margin:0 0 10px}
    .muted{color:var(--muted);font-size:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;outline:none}
    textarea{min-height:92px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .stack{display:grid;gap:10px}
    hr{border:0;border-top:1px solid var(--line);margin:14px 0}

    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:#ecfeff}
    .badge.busy{background:#fee2e2}
    .badge.break{background:#fff7ed;color:#7c2d12}

    table{width:100%;border-collapse:collapse}
    th,td{font-size:13px;padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:900}

    .kpi{border:1px solid var(--line);border-radius:16px;padding:12px;background:linear-gradient(180deg,#fff,#fafafa)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:22px;font-weight:1000;margin-top:4px}
    .kpi .sub{font-size:12px;color:var(--muted);margin-top:6px}

    .hint{padding:10px 12px;border-radius:16px;border:1px dashed var(--line);background:#fafafa;color:#374151;font-size:13px}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--soft);
      font-size:12px;border:1px solid rgba(0,0,0,.06)}
    .chip.good{color:var(--good)} .chip.bad{color:var(--bad)} .chip.warn{color:var(--warn)}

    .staffGrid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
    @media (max-width: 950px){ .staffGrid{grid-template-columns:1fr} }
    .staffCard{
      border:1px solid var(--line);border-radius:16px;padding:12px;background:linear-gradient(180deg,#fff,#fbfbfb);
      cursor:pointer; transition:transform .12s ease, box-shadow .12s ease
    }
    .staffCard:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(0,0,0,.10)}
    .staffCard .name{font-weight:1000}
    .skills{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .miniRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .mini{padding:8px 10px;border-radius:14px;border:1px solid var(--line);background:#fff;min-width:140px}
    .mini .mLabel{font-size:11px;color:var(--muted)}
    .mini .mVal{font-weight:1000;margin-top:2px}

    .cartItem{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:10px;background:#fff}
    .cartLeft{display:grid;gap:2px}
    .cartTitle{font-weight:900}
    .cartMeta{font-size:12px;color:var(--muted)}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>Nail Salon</div>
        <span class="badge">VNĐ • Tip • Auto Assign</span>
      </div>

      <nav class="nav">
        <a href="#" data-page="dashboard" class="active">Dashboard</a>
        <a href="#" data-page="quick">Quick Assign</a>
        <a href="#" data-page="employees">Employees</a>
        <a href="#" data-page="services">Services</a>
        <a href="#" data-page="jobs">Jobs</a>
      </nav>

      <div class="row" style="gap:8px;">
        <button class="btn ghost" onclick="exportJSON()">Export</button>
        <button class="btn ghost" onclick="importJSON()">Import</button>
        <button class="btn ghost" onclick="resetDay()">Reset Day</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="card">
      <h2 class="title">KPI Overview</h2>
      <div class="grid grid-3" id="kpiGrid"></div>

      <hr>

      <div class="row" style="align-items:flex-end;">
        <div>
          <div class="title" style="margin:0;">Balance Board</div>
          <div class="muted">
            Auto-assign cân bằng theo <b>Service Revenue</b> (tiền làm). Tip được tách riêng để bạn chốt cuối ngày.
          </div>
        </div>
        <button class="btn ghost" onclick="toggleBalanceSort()">Sort</button>
      </div>

      <div style="overflow:auto;margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Thợ</th><th>Status</th><th>Service</th><th>Tip</th><th>Gross</th><th>Gap vs Target</th><th>Jobs</th>
            </tr>
          </thead>
          <tbody id="balanceBody"></tbody>
        </table>
      </div>
    </section>

    <!-- QUICK ASSIGN (NEW DESIGN) -->
    <section id="page-quick" class="grid grid-2 hide">
      <div class="card">
        <div class="row">
          <h2 class="title" style="margin:0;">Quick Assign</h2>
          <div class="muted">Chọn dịch vụ → giá auto → Add vào cart → Auto/Manual assign</div>
        </div>

        <div class="hint" style="margin-top:10px;">
          ✅ Không có “tên khách dưới nhân viên”. Khi assign, hệ thống sẽ hỏi tên khách 1 lần bằng popup.
          <br/>✅ Bạn có thể <b>edit giá</b> ngay tại đây (ví dụ promo/khác giá) rồi Add vào cart.
        </div>

        <div class="grid grid-2" style="margin-top:10px;">
          <div>
            <label>Chọn dịch vụ</label>
            <select id="qService"></select>
          </div>
          <div>
            <label>Giá (VNĐ) – auto, có thể sửa</label>
            <input id="qPrice" type="number" min="0" />
          </div>
        </div>

        <button class="btn ghost" style="margin-top:10px;" onclick="addToCart()">Add service</button>

        <div style="margin-top:10px;">
          <div class="row">
            <div style="font-weight:900;">Cart</div>
            <div class="muted">Service Total: <b id="cartTotal">0₫</b></div>
          </div>
          <div id="cartBox" class="stack" style="margin-top:8px;"></div>
        </div>

        <div class="grid grid-2" style="margin-top:10px;">
          <button class="btn" onclick="autoAssign()">Auto Assign (balance)</button>
          <button class="btn ghost" onclick="clearCart()">Clear Cart</button>
        </div>

        <div class="muted" id="qMsg" style="margin-top:8px;"></div>

        <hr>

        <div class="title" style="margin:0;">Now Serving</div>
        <div id="nowServing" class="stack" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="title" style="margin:0;">Nhân viên phù hợp</div>
            <div class="muted">Click vào card để <b>assign thủ công</b>. Chỉ hiện thợ Available + match đủ skill trong cart.</div>
          </div>
          <span class="badge" id="eligibleCount">0 eligible</span>
        </div>

        <div class="hint" style="margin-top:10px;">
          Auto-assign chọn người có <b>Service Revenue thấp nhất</b> (để đều). Tip không dùng để cân bằng.
        </div>

        <div class="staffGrid" id="eligibleGrid" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- EMPLOYEES -->
    <section id="page-employees" class="card hide">
      <div class="row">
        <h2 class="title" style="margin:0;">Employees</h2>
        <div class="muted">Edit tên + skills + status (Available / Break)</div>
      </div>

      <div class="grid grid-2" style="margin-top:10px;">
        <div class="card" style="box-shadow:none;border:1px solid var(--line);">
          <div style="font-weight:900;margin-bottom:8px;">Add / Edit Employee</div>
          <input id="empId" type="hidden" />
          <div class="stack">
            <div>
              <label>Tên</label>
              <input id="empName" placeholder="VD: Vy" />
            </div>
            <div>
              <label>Skills (ngăn cách bằng dấu phẩy hoặc xuống dòng)</label>
              <textarea id="empSkills" placeholder="VD: des simple, design, wax, gội, facial"></textarea>
            </div>
            <div class="grid grid-2">
              <div>
                <label>Status</label>
                <select id="empStatus">
                  <option value="available">Available</option>
                  <option value="break">Break</option>
                </select>
              </div>
              <div>
                <label>Commission % (optional)</label>
                <input id="empCommission" type="number" min="0" step="0.1" placeholder="VD: 40" />
              </div>
            </div>

            <div class="row">
              <button class="btn" onclick="saveEmployee()">Save</button>
              <button class="btn ghost" onclick="clearEmpForm()">Clear</button>
            </div>
            <div class="muted">Tip: skill nên chứa chữ “wax”, “gội”, “design”, “des simple”, “facial”… để match.</div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;border:1px solid var(--line);">
          <div class="row">
            <div style="font-weight:900;">Staff List</div>
            <div class="muted">Break sẽ không được assign</div>
          </div>
          <div id="staffList" class="stack" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <!-- SERVICES -->
    <section id="page-services" class="card hide">
      <div class="row">
        <h2 class="title" style="margin:0;">Services (VNĐ)</h2>
        <div class="muted">Service name + Skill tag + Price. Chọn dịch vụ sẽ tự hiện giá.</div>
      </div>

      <div class="grid grid-2" style="margin-top:10px;">
        <div class="card" style="box-shadow:none;border:1px solid var(--line);">
          <div style="font-weight:900;margin-bottom:8px;">Add / Update Service</div>
          <div class="stack">
            <div>
              <label>Service name</label>
              <input id="svName" placeholder="VD: Sơn gel (tay/chân)" />
            </div>
            <div class="grid grid-2">
              <div>
                <label>Skill tag</label>
                <input id="svSkill" placeholder="VD: des simple / wax / gội / facial" />
              </div>
              <div>
                <label>Price (VNĐ)</label>
                <input id="svPrice" type="number" min="0" placeholder="VD: 360000" />
              </div>
            </div>

            <div class="row">
              <button class="btn" onclick="saveService()">Save</button>
              <button class="btn ghost" onclick="clearServiceForm()">Clear</button>
            </div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;border:1px solid var(--line);">
          <div class="row">
            <div style="font-weight:900;">Current Services</div>
            <span class="muted" id="svCount"></span>
          </div>
          <div style="overflow:auto;margin-top:10px;">
            <table>
              <thead><tr><th>Service</th><th>Skill</th><th>Price</th><th></th></tr></thead>
              <tbody id="svBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- JOBS -->
    <section id="page-jobs" class="card hide">
      <h2 class="title">Jobs</h2>
      <div class="muted">Mỗi job lưu: service total + tip + gross + payment method</div>
      <div style="overflow:auto;margin-top:10px;">
        <table>
          <thead>
            <tr><th>Khách</th><th>Services</th><th>Service</th><th>Tip</th><th>Gross</th><th>Payment</th><th>Thợ</th><th>Status</th></tr>
          </thead>
          <tbody id="jobsBody"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
/* =========================
   STATE + HELPERS
========================= */
const STORAGE_KEY = "nail_salon_vnd_tip_v1";

const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const norm = (s)=>String(s||"").trim().toLowerCase();
const vnd = (n)=> {
  const x = Math.round(Number(n||0));
  return x.toLocaleString("vi-VN") + "₫";
};

// staff default (bạn edit trong tab Employees)
const STAFF_DEFAULT = [
  {id:1, name:"Ha ha", skills:["Design","đấp bột"], status:"available"},
  {id:2, name:"bánh mì", skills:["Design","đắp bột","cắt da Nga"], status:"available"},
  {id:3, name:"thùy", skills:["design","extension","heel"], status:"available"},
  {id:4, name:"Na", skills:["design","extension","heel"], status:"available"},
  {id:5, name:"Tâm", skills:["des simple","H & F spa"], status:"available"},
  {id:6, name:"Muối", skills:["des simple","H & F spa"], status:"available"},
  {id:7, name:"Thoa", skills:["des simple","H & F spa","gel X"], status:"available"},
  {id:8, name:"Vy", skills:["des simple","french","cắt da Nga","wax (H,F,brow…)"], status:"available"},
  {id:9, name:"Demi", skills:["des simple","H & F spa","gội","Body"], status:"available"},
  {id:10, name:"Nhung", skills:["lashes"], status:"available"},
  {id:11, name:"Dung", skills:["Body","facial"], status:"available"},
  {id:12, name:"Sathia", skills:["gội","body","wax (all)","facial"], status:"available"},
  {id:13, name:"Linh", skills:["body","facial"], status:"available"},
  {id:14, name:"Iris", skills:["gội","body","facial"], status:"available"},
].map(s=>({ ...s, serviceRevenue:0, tipRevenue:0, jobsDone:0, current:null, commission:null }));

// services default (seed từ menu – bạn có thể thêm/sửa)
const SERVICES_DEFAULT = [
  // cắt da
  {id:1, name:"Cắt da tay (Kỹ thuật Privé)", skill:"cắt da", price:125000},
  {id:2, name:"Cắt da tay+chân (Kỹ thuật Privé)", skill:"cắt da", price:240000},

  // sơn thường / gel
  {id:3, name:"Làm móng – Sơn thường (tay/chân)", skill:"des simple", price:235000},
  {id:4, name:"Làm móng – Sơn thường (tay+chân)", skill:"des simple", price:460000},
  {id:5, name:"Làm móng – Sơn gel (tay/chân)", skill:"des simple", price:360000},
  {id:6, name:"Làm móng – Sơn gel (tay+chân)", skill:"des simple", price:710000},

  // wax
  {id:7, name:"Wax – Vùng môi", skill:"wax", price:145000},
  {id:8, name:"Wax – Vùng chân mày", skill:"wax", price:175000},

  // gội
  {id:9,  name:"Gội đầu thư giãn (tóc ngắn/trung bình)", skill:"gội", price:255000},
  {id:10, name:"Gội đầu thư giãn (tóc dài)", skill:"gội", price:355000},
];

function defaultState(){
  return {
    staff: structuredClone(STAFF_DEFAULT),
    services: structuredClone(SERVICES_DEFAULT),
    cart: [], // list of {serviceId, priceOverride?}
    jobs: [],
    ui: { balanceSort:"gap" }
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(!s.staff || !s.services) return defaultState();
    s.cart ||= [];
    s.jobs ||= [];
    s.ui ||= {balanceSort:"gap"};
    return s;
  }catch{ return defaultState(); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

let state = loadState();

/* =========================
   NAV
========================= */
document.querySelectorAll(".nav a").forEach(a=>{
  a.addEventListener("click",(e)=>{
    e.preventDefault();
    setPage(a.dataset.page);
  });
});
function setPage(page){
  document.querySelectorAll(".nav a").forEach(x=>x.classList.toggle("active", x.dataset.page===page));
  document.querySelectorAll("[id^='page-']").forEach(sec=>sec.classList.add("hide"));
  $("page-"+page).classList.remove("hide");
  renderAll();
}

/* =========================
   SERVICES SELECT + AUTO PRICE
========================= */
function getServiceById(id){ return state.services.find(s=>s.id===id) || null; }
function sortedServices(){ return state.services.slice().sort((a,b)=>a.name.localeCompare(b.name)); }

function setServiceSelect(){
  const opt = sortedServices().map(s=>`<option value="${s.id}">${esc(s.name)}</option>`).join("");
  $("qService").innerHTML = opt;
  // fill price
  const s = getServiceById(Number($("qService").value));
  $("qPrice").value = s ? s.price : "";
}
$("qService").addEventListener("change", ()=>{
  const s = getServiceById(Number($("qService").value));
  $("qPrice").value = s ? s.price : "";
});

/* =========================
   CART (price override allowed)
========================= */
function cartLineTotal(line){
  const svc = getServiceById(line.serviceId);
  if(!svc) return 0;
  const p = Number.isFinite(line.priceOverride) ? line.priceOverride : svc.price;
  return Number(p||0);
}
function cartServiceTotal(){
  return state.cart.reduce((sum,line)=>sum + cartLineTotal(line), 0);
}
function renderCart(){
  $("cartTotal").textContent = vnd(cartServiceTotal());
  const host = $("cartBox");
  if(state.cart.length===0){
    host.innerHTML = `<div class="muted">Chưa có dịch vụ nào.</div>`;
    return;
  }
  host.innerHTML = state.cart.map((line,idx)=>{
    const svc = getServiceById(line.serviceId);
    const price = cartLineTotal(line);
    return `
      <div class="cartItem">
        <div class="cartLeft">
          <div class="cartTitle">${esc(svc?.name || "Unknown")}</div>
          <div class="cartMeta">Skill tag: <b>${esc(svc?.skill||"-")}</b> • Price: <b>${vnd(price)}</b></div>
        </div>
        <button class="btn ghost" onclick="removeFromCart(${idx})">Remove</button>
      </div>
    `;
  }).join("");
}
function addToCart(){
  const id = Number($("qService").value);
  const svc = getServiceById(id);
  if(!svc) return;

  const edited = Number($("qPrice").value);
  if(!Number.isFinite(edited) || edited<=0) return alert("Giá không hợp lệ.");

  // store price override if edited differs
  const line = { serviceId:id };
  if(edited !== svc.price) line.priceOverride = edited;

  state.cart.push(line);
  saveState();
  renderAll();
}
function removeFromCart(index){
  state.cart.splice(index,1);
  saveState();
  renderAll();
}
function clearCart(){
  state.cart = [];
  saveState();
  renderAll();
}

/* =========================
   MATCHING STAFF
========================= */
function staffMatchesSkill(staff, skillTag){
  const tag = norm(skillTag);
  // contains match: wax(all) match wax
  return staff.skills.some(sk => norm(sk).includes(tag));
}
function neededSkillTagsFromCart(){
  const tags = state.cart.map(line=>{
    const svc = getServiceById(line.serviceId);
    return svc?.skill;
  }).filter(Boolean);
  // unique
  return Array.from(new Set(tags.map(norm))).map(t=>t);
}
function eligibleStaff(){
  const tags = neededSkillTagsFromCart();
  return state.staff.filter(st=>{
    if(st.status!=="available") return false;
    // must match all tags in cart
    return tags.every(t => staffMatchesSkill(st, t));
  });
}

// auto-balance based on service revenue only
function pickAutoStaff(){
  const list = eligibleStaff();
  if(list.length===0) return null;
  // projected after taking this job
  const serviceTotal = cartServiceTotal();
  list.sort((a,b)=>(a.serviceRevenue + serviceTotal) - (b.serviceRevenue + serviceTotal));
  return list[0];
}

function renderEligibleStaff(){
  const list = eligibleStaff();
  $("eligibleCount").textContent = `${list.length} eligible`;

  const grid = $("eligibleGrid");
  if(state.cart.length===0){
    grid.innerHTML = `<div class="muted">Thêm dịch vụ vào cart để hiện danh sách nhân viên phù hợp.</div>`;
    return;
  }
  if(list.length===0){
    grid.innerHTML = `<div class="muted">Không có thợ Available match đủ skill (hoặc đang Break).</div>`;
    return;
  }

  const serviceTotal = cartServiceTotal();
  grid.innerHTML = list.map(st=>{
    const projected = st.serviceRevenue + serviceTotal;
    const badge = `<span class="badge">Available</span>`;
    return `
      <div class="staffCard" onclick="manualAssign(${st.id})">
        <div class="row">
          <div class="name">${esc(st.name)}</div>
          ${badge}
        </div>
        <div class="miniRow">
          <div class="mini"><div class="mLabel">Service Revenue</div><div class="mVal">${vnd(st.serviceRevenue)}</div></div>
          <div class="mini"><div class="mLabel">Tip</div><div class="mVal">${vnd(st.tipRevenue)}</div></div>
          <div class="mini"><div class="mLabel">Projected (service)</div><div class="mVal">${vnd(projected)}</div></div>
        </div>
        <div class="skills">
          ${st.skills.slice(0,8).map(sk=>`<span class="chip">${esc(sk)}</span>`).join("")}
          ${st.skills.length>8 ? `<span class="chip">+${st.skills.length-8}</span>` : ``}
        </div>
        <div class="muted" style="margin-top:8px;">Click để assign thủ công</div>
      </div>
    `;
  }).join("");
}

/* =========================
   ASSIGN + DONE (with TIP)
========================= */
function askCustomerName(){
  const name = prompt("Nhập tên khách (có thể bỏ trống):", "");
  return (name ?? "").trim();
}

function doAssignToStaff(staffId, modeLabel){
  if(state.cart.length===0) return $("qMsg").textContent = "Cart trống. Add dịch vụ trước nha.";

  const st = state.staff.find(x=>x.id===staffId);
  if(!st) return;
  if(st.status!=="available") return $("qMsg").textContent = "Thợ không Available.";

  const customer = askCustomerName();
  const serviceTotal = cartServiceTotal();

  st.status = "busy";
  st.current = {
    customer,
    cart: structuredClone(state.cart),
    serviceTotal,
    tip: 0,
    payment: "Cash",
    fee: 0,
    gross: serviceTotal
  };

  state.jobs.push({
    customer,
    staffId: st.id,
    cart: structuredClone(state.cart),
    serviceTotal,
    tip: 0,
    payment: "Cash",
    fee: 0,
    gross: serviceTotal,
    status:"In progress",
    ts: Date.now()
  });

  state.cart = [];
  $("qMsg").textContent = `✅ Assigned (${modeLabel}) cho thợ ${st.name}. Service total: ${vnd(serviceTotal)}`;
  saveState();
  renderAll();
}

function manualAssign(staffId){
  doAssignToStaff(staffId, "Manual");
}
function autoAssign(){
  const pick = pickAutoStaff();
  if(!pick) return $("qMsg").textContent = "❌ Không có thợ Available match đủ skill (hoặc đang Break).";
  doAssignToStaff(pick.id, "Auto-balance");
}

function updateJobDone(staffId, tip, payment, fee){
  const st = state.staff.find(x=>x.id===staffId);
  if(!st || !st.current) return;

  // update staff totals
  st.serviceRevenue += Number(st.current.serviceTotal||0);
  st.tipRevenue += Number(tip||0);
  st.jobsDone += 1;

  // mark last in-progress job for this staff
  for(let i=state.jobs.length-1;i>=0;i--){
    const j = state.jobs[i];
    if(j.staffId===staffId && j.status==="In progress"){
      j.status = "Done";
      j.tip = tip;
      j.payment = payment;
      j.fee = fee;
      j.gross = Number(j.serviceTotal||0) + Number(tip||0) + Number(fee||0);
      break;
    }
  }

  // clear current & set available
  st.current = null;
  st.status = "available";

  saveState();
  renderAll();
}

function markDone(staffId){
  const st = state.staff.find(x=>x.id===staffId);
  if(!st || !st.current) return;

  // ask tip
  const tipRaw = prompt("Nhập tiền tip (VNĐ). Nếu không có, để 0:", "0");
  const tip = Math.max(0, Number(tipRaw||0) || 0);

  // payment method (fee rule optional)
  const payment = prompt("Payment method? (Cash / Card / QR / E-wallet)", "Cash") || "Cash";
  const pm = payment.trim();

  // Optional: fee 5% for non-cash (you can turn this off later)
  // If you don't want fee: set fee = 0 always.
  let fee = 0;
  const isNonCash = !/cash/i.test(pm);
  if(isNonCash){
    const confirmFee = confirm("Áp dụng phí xử lý 5% cho Card/QR/E-wallet?");
    if(confirmFee){
      fee = Math.round((Number(st.current.serviceTotal||0) + tip) * 0.05);
    }
  }

  updateJobDone(staffId, tip, pm, fee);
}

/* =========================
   NOW SERVING
========================= */
function renderNowServing(){
  const busy = state.staff.filter(s=>s.status==="busy" && s.current);
  const host = $("nowServing");
  if(busy.length===0){
    host.innerHTML = `<div class="muted">Chưa có ai đang phục vụ.</div>`;
    return;
  }
  host.innerHTML = busy.map(s=>{
    const services = (s.current.cart||[]).map(line=>{
      const svc = getServiceById(line.serviceId);
      const price = cartLineTotal(line);
      return `${svc?.name || "Unknown"} (${vnd(price)})`;
    }).join(" • ");
    return `
      <div class="staffCard" style="cursor:default;">
        <div class="row">
          <div class="name">${esc(s.name)}</div>
          <span class="badge busy">Busy</span>
        </div>
        <div class="muted" style="margin-top:6px;">
          Khách: <b>${esc(s.current.customer || "—")}</b><br/>
          Service total: <b>${vnd(s.current.serviceTotal)}</b><br/>
          Services: ${esc(services)}
        </div>
        <div style="margin-top:10px;">
          <button class="btn ghost" onclick="markDone(${s.id})">Done (Ask tip)</button>
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
   DASHBOARD ANALYTICS
========================= */
function renderKPI(){
  const serviceSum = state.staff.reduce((a,s)=>a+s.serviceRevenue,0);
  const tipSum = state.staff.reduce((a,s)=>a+s.tipRevenue,0);
  const gross = serviceSum + tipSum;

  const n = state.staff.length || 1;
  const targetService = serviceSum / n;

  const busy = state.staff.filter(s=>s.status==="busy").length;
  const brk = state.staff.filter(s=>s.status==="break").length;

  const cards = [
    {label:"Service Revenue", value:vnd(serviceSum), sub:`Target/staff: ${vnd(targetService)}`},
    {label:"Tip Total", value:vnd(tipSum), sub:"Tách riêng để chốt cuối ngày"},
    {label:"Gross (Service+Tip)", value:vnd(gross), sub:"Chưa tính fee nếu có"},
    {label:"Staff Status", value:`Busy ${busy} • Break ${brk}`, sub:`Available ${state.staff.length-busy-brk}`},
    {label:"Jobs Done", value:String(state.jobs.filter(j=>j.status==="Done").length), sub:`In progress ${state.jobs.filter(j=>j.status==="In progress").length}`},
    {label:"Services", value:String(state.services.length), sub:"Trong catalog"},
  ];
  $("kpiGrid").innerHTML = cards.map(c=>`
    <div class="kpi">
      <div class="label">${esc(c.label)}</div>
      <div class="value">${esc(c.value)}</div>
      <div class="sub">${esc(c.sub||"")}</div>
    </div>
  `).join("");
}

function renderBalanceBoard(){
  const serviceSum = state.staff.reduce((a,s)=>a+s.serviceRevenue,0);
  const target = serviceSum / (state.staff.length||1);

  let list = [...state.staff];
  const sort = state.ui.balanceSort;
  if(sort==="gap"){
    list.sort((a,b)=>Math.abs(b.serviceRevenue-target)-Math.abs(a.serviceRevenue-target));
  }else if(sort==="service"){
    list.sort((a,b)=>b.serviceRevenue-a.serviceRevenue);
  }else{
    list.sort((a,b)=>a.name.localeCompare(b.name));
  }

  $("balanceBody").innerHTML = list.map(s=>{
    const gap = s.serviceRevenue - target;
    const badge = s.status==="available" ? `<span class="badge">Available</span>`
      : (s.status==="break" ? `<span class="badge break">Break</span>` : `<span class="badge busy">Busy</span>`);
    const gross = s.serviceRevenue + s.tipRevenue;
    const gapStyle = gap>=0 ? "style='color:var(--bad);font-weight:1000'" : "style='color:var(--good);font-weight:1000'";
    return `
      <tr>
        <td><b>${esc(s.name)}</b></td>
        <td>${badge}</td>
        <td><b>${vnd(s.serviceRevenue)}</b></td>
        <td>${vnd(s.tipRevenue)}</td>
        <td><b>${vnd(gross)}</b></td>
        <td ${gapStyle}>${gap>=0?"+":""}${vnd(gap)}</td>
        <td>${s.jobsDone}</td>
      </tr>
    `;
  }).join("");
}

function toggleBalanceSort(){
  const v = state.ui.balanceSort;
  state.ui.balanceSort = (v==="gap") ? "service" : (v==="service" ? "name" : "gap");
  saveState(); renderAll();
}

/* =========================
   EMPLOYEES CRUD (simple list)
========================= */
function parseSkills(text){
  const parts = String(text||"").split(/\n|,/).map(x=>x.trim()).filter(Boolean);
  return Array.from(new Set(parts));
}
function clearEmpForm(){
  $("empId").value="";
  $("empName").value="";
  $("empSkills").value="";
  $("empStatus").value="available";
  $("empCommission").value="";
}
function saveEmployee(){
  const idRaw = $("empId").value;
  const name = $("empName").value.trim();
  const skills = parseSkills($("empSkills").value);
  const status = $("empStatus").value;
  const commission = $("empCommission").value.trim()==="" ? null : Number($("empCommission").value);

  if(!name) return alert("Nhập tên thợ.");
  if(skills.length===0) return alert("Nhập ít nhất 1 skill.");

  if(idRaw){
    const st = state.staff.find(s=>s.id===Number(idRaw));
    if(!st) return;
    st.name = name;
    st.skills = skills;
    if(st.status!=="busy") st.status = status;
    st.commission = Number.isFinite(commission)?commission:null;
  }else{
    const newId = Math.max(0,...state.staff.map(s=>s.id))+1;
    state.staff.push({
      id:newId, name, skills, status,
      serviceRevenue:0, tipRevenue:0, jobsDone:0, current:null, commission:Number.isFinite(commission)?commission:null
    });
  }
  saveState(); clearEmpForm(); renderAll();
}
function editEmployee(id){
  const st = state.staff.find(s=>s.id===id);
  if(!st) return;
  $("empId").value = st.id;
  $("empName").value = st.name;
  $("empSkills").value = st.skills.join(", ");
  $("empStatus").value = (st.status==="busy") ? "available" : st.status;
  $("empCommission").value = st.commission ?? "";
}
function toggleBreakEmp(id){
  const st = state.staff.find(s=>s.id===id);
  if(!st) return;
  if(st.status==="busy") return alert("Thợ đang Busy.");
  st.status = (st.status==="break") ? "available" : "break";
  saveState(); renderAll();
}
function deleteEmp(id){
  const st = state.staff.find(s=>s.id===id);
  if(!st) return;
  if(st.status==="busy") return alert("Thợ đang Busy.");
  if(confirm(`Xoá thợ "${st.name}"?`)){
    state.staff = state.staff.filter(s=>s.id!==id);
    saveState(); renderAll();
  }
}
function renderEmployees(){
  const host = $("staffList");
  host.innerHTML = state.staff.map(st=>{
    const badge = st.status==="available" ? `<span class="badge">Available</span>` :
      (st.status==="break" ? `<span class="badge break">Break</span>` : `<span class="badge busy">Busy</span>`);
    return `
      <div class="cartItem">
        <div class="cartLeft">
          <div class="cartTitle">${esc(st.name)} ${badge}</div>
          <div class="cartMeta">Skills: ${esc(st.skills.join(", "))}</div>
          <div class="cartMeta">Service: <b>${vnd(st.serviceRevenue)}</b> • Tip: <b>${vnd(st.tipRevenue)}</b></div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn ghost" onclick="editEmployee(${st.id})">Edit</button>
          <button class="btn ghost" onclick="toggleBreakEmp(${st.id})">Break</button>
          <button class="btn danger" onclick="deleteEmp(${st.id})">Delete</button>
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
   SERVICES CRUD
========================= */
function clearServiceForm(){
  $("svName").value=""; $("svSkill").value=""; $("svPrice").value="";
}
function saveService(){
  const name = $("svName").value.trim();
  const skill = $("svSkill").value.trim();
  const price = Number($("svPrice").value);
  if(!name) return alert("Nhập tên service.");
  if(!skill) return alert("Nhập skill tag.");
  if(!Number.isFinite(price) || price<=0) return alert("Giá không hợp lệ.");

  const existing = state.services.find(s=>norm(s.name)===norm(name));
  if(existing){
    existing.skill = skill;
    existing.price = price;
  }else{
    const newId = Math.max(0,...state.services.map(s=>s.id))+1;
    state.services.push({id:newId,name,skill,price});
  }
  saveState(); clearServiceForm(); renderAll();
}
function deleteService(id){
  if(confirm("Xoá service này?")){
    state.services = state.services.filter(s=>s.id!==id);
    state.cart = state.cart.filter(line=>line.serviceId!==id);
    saveState(); renderAll();
  }
}
function renderServices(){
  const list = sortedServices();
  $("svCount").textContent = `${list.length} services`;
  $("svBody").innerHTML = list.map(s=>`
    <tr>
      <td>${esc(s.name)}</td>
      <td><b>${esc(s.skill)}</b></td>
      <td>${vnd(s.price)}</td>
      <td><button class="btn ghost" onclick="deleteService(${s.id})">Delete</button></td>
    </tr>
  `).join("");
}

/* =========================
   JOBS TABLE
========================= */
function renderJobs(){
  $("jobsBody").innerHTML = state.jobs.slice().reverse().map(j=>{
    const st = state.staff.find(s=>s.id===j.staffId);
    const svcNames = (j.cart||[]).map(line=>{
      const svc = getServiceById(line.serviceId);
      const price = cartLineTotal(line);
      return `${svc?.name || "Unknown"} (${vnd(price)})`;
    }).join(" • ");
    return `
      <tr>
        <td>${esc(j.customer||"")}</td>
        <td>${esc(svcNames)}</td>
        <td><b>${vnd(j.serviceTotal||0)}</b></td>
        <td>${vnd(j.tip||0)}</td>
        <td><b>${vnd((j.gross||0))}</b></td>
        <td>${esc(j.payment||"")}${j.fee?` (+${vnd(j.fee)})`:``}</td>
        <td>${esc(st?.name || "")}</td>
        <td>${esc(j.status||"")}</td>
      </tr>
    `;
  }).join("");
}

/* =========================
   EXPORT/IMPORT/RESET
========================= */
function exportJSON(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="nail-salon-backup.json"; a.click();
  URL.revokeObjectURL(url);
}
function importJSON(){
  const input=document.createElement("input");
  input.type="file"; input.accept="application/json";
  input.onchange=()=>{
    const f=input.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(String(r.result||""));
        if(!parsed.staff || !parsed.services) throw new Error("bad");
        state=parsed;
        state.cart ||= [];
        state.jobs ||= [];
        state.ui ||= {balanceSort:"gap"};
        saveState(); renderAll(); alert("Import OK!");
      }catch{ alert("File không hợp lệ."); }
    };
    r.readAsText(f);
  };
  input.click();
}
function resetDay(){
  if(!confirm("Reset doanh thu + jobs hôm nay?")) return;
  state = defaultState();
  saveState();
  renderAll();
}

/* =========================
   RENDER ALL
========================= */
function renderAll(){
  // selects
  setServiceSelect();
  // cart
  renderCart();
  // quick staff list
  renderEligibleStaff();
  // now serving
  renderNowServing();
  // dashboard
  renderKPI();
  renderBalanceBoard();
  // employees/services/jobs pages
  renderEmployees();
  renderServices();
  renderJobs();
}
renderAll();
</script>
</body>
</html>
